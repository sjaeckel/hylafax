#!@SCRIPT_SH@
#	$Header: /usr/people/sam/fax/./html/tools/RCS/majordomo.sh.in,v 1.6 1995/04/08 21:48:01 sam Rel $
#
# Copyright (c) 1994-1995 Sam Leffler
# Copyright (c) 1994-1995 Silicon Graphics, Inc.
# 
# Permission to use, copy, modify, distribute, and sell this software and 
# its documentation for any purpose is hereby granted without fee, provided
# that (i) the above copyright notices and this permission notice appear in
# all copies of the software and related documentation, and (ii) the names of
# Sam Leffler and Silicon Graphics may not be used in any advertising or
# publicity relating to the software without the specific, prior written
# permission of Sam Leffler and Silicon Graphics.
# 
# THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
# EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
# WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
# 
# IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
# ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
# OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
# LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
# OF THIS SOFTWARE.
#

#
# majordomo
#
# Submit a mail message to a Majordomo server.  This script
# expects to be invoked from a "QUERY" form.  The destination
# mail address is taken from a HIDDEN input type whose name
# is "majordomo"; e.g.  The number of potential mailing list
# requests is taken from the HIDDEN input type whose name is
# "nrequests".  Requests are of the form "req<n>" where <n>
# is a decimal number that goes from 0-nrequests.
#
# <FORM  METHOD="query" ACTION="http:/cgi-bin/majordomo">
# Subscribe	<INPUT TYPE=checkbox NAME=req1 VALUE="subscribe listname">
# <KBD>listname@machine</KBD>
# <BR>
# EMail Address:<INPUT NAME="mailaddr" SIZE="45">
# <INPUT TYPE=hidden VALUE=host NAME=nrequests>
# <INPUT TYPE=hidden VALUE=host NAME=majordomo>
# <INPUT TYPE=submit VALUE="Submit to Majordomo@host">
# </FORM>
#
PATH=/bin:/usr/bin
test -d /usr/sbin && PATH=$PATH:/usr/sbin		# SGI and others
test -d /usr/5bin && PATH=/usr/5bin:$PATH		# Sun and others
test -d /usr/local/bin && PATH=/usr/local/bin:$PATH	# for GNU stuff

SENDMAIL=@SENDMAIL@
ECHO=@ECHO@
SED=@SED@
CAT=@CAT@
UNQUOTE=@CGIDIR@/unquote

$ECHO 'Content-type: text/html'
$ECHO ''

eval `$ECHO "$QUERY_STRING" | $UNQUOTE doquotes | $SED 's/PATH=[^;]*;//g'`

echoMail()
{
    $ECHO "To: Majordomo@$majordomo"
    $ECHO ""
    (i=0
    eval f=\"\$req${i}\"
    while expr $i \<= $nrequests >/dev/null
    do
	test "$f" && $ECHO "$f $mailaddr"
	i=`expr $i + 1`
	eval f=\"\$req${i}\"
    done) | $UNQUOTE
}

$ECHO '<TITLE>Majordomo Submission Result</TITLE>'

if [ -z "$majordomo" ]; then
    $ECHO "<H2><IMG SRC=\"@HTMLPATH@/icons/button.excl.gif\" HSPACE=8> No Majordomo Server</H2>"
    $ECHO 'Your Majordomo submission was not posted because the Majordomo'
    $ECHO "server's electronic mail address was not setup in the associated"
    $ECHO 'HTML document.  This is a problem in the document that must be'
    $ECHO 'fixed by the author of the document.  Sorry.'
    exit
fi
if [ -z "$nrequests" ]; then
    $ECHO "<H2><IMG SRC=\"@HTMLPATH@/icons/button.excl.gif\" HSPACE=8> Missing nrequests</H2>"
    $ECHO 'Your Majordomo submission was not posted because the number of'
    $ECHO 'possible mailing list requests (nrequests) was not setup in the'
    $ECHO 'associated HTML document.  This is a problem in the document that'
    $ECHO 'must be fixed by the author of the document.  Sorry.'
    exit
fi
if [ -z "$mailaddr" ]; then
    $ECHO "<H2><IMG SRC=\"@HTMLPATH@/icons/button.excl.gif\" HSPACE=8> No Mail Address</H2>"
    $ECHO 'Your Majordomo submission was not posted because you failed to'
    $ECHO 'fillin your electronic mail address.  Go back to the previous'
    $ECHO 'page, fill in the address, and resubmit your request.'
    exit
fi

(echoMail | $SENDMAIL -oi -f$mailaddr Majordomo@$majordomo) || {
    $ECHO "<H2><IMG SRC=\"@HTMLPATH@/icons/button.excl.gif\" HSPACE=8> Mail Posting Problem</H2>"
    $ECHO 'There was a problem posting your Majordomo submission.'
    exit
}

$ECHO "<H1>Submission to Majordomo@$majordomo</H1>"
$ECHO 'The following mail was successfully posted:'
$ECHO ''
$ECHO '<PRE>'
echoMail
$CAT<<EOF
</PRE>
<P>

You should receive a reply shortly that
confirms your mailing list subscriptions.
<P>

<HR>

<ADDRESS>Majordomo-owner@$majordomo</ADDRESS>
</BODY>
</HTML>
EOF
