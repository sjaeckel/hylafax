#!@SCRIPT_SH@
#	$Header: /usr/people/sam/fax/./html/tools/RCS/cat-pages.sh.in,v 1.10 1995/04/08 21:47:58 sam Rel $
#
# Copyright (c) 1994-1995 Sam Leffler
# Copyright (c) 1994-1995 Silicon Graphics, Inc.
# 
# Permission to use, copy, modify, distribute, and sell this software and 
# its documentation for any purpose is hereby granted without fee, provided
# that (i) the above copyright notices and this permission notice appear in
# all copies of the software and related documentation, and (ii) the names of
# Sam Leffler and Silicon Graphics may not be used in any advertising or
# publicity relating to the software without the specific, prior written
# permission of Sam Leffler and Silicon Graphics.
# 
# THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
# EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
# WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
# 
# IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
# ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
# OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
# LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
# OF THIS SOFTWARE.
#

#
# cat-pages
#
# Return an HTML document that is the concatenation of the requested
# document files.  This QUERY script is useful for collecting a large
# document that's been split into multiple pages so that it can, for
# example, be printed.  The documents are assumed to reside in a
# single tree under the virtual pathname appended to the script.
# One document is identified as the ``index file'' (IF) and emitted
# first, together with it's HEAD section.  Other files (OF*) are then
# written out w/o any HEAD and ADDRESS sections, and w/o <HTML></HTML>
# tags.
#
# NB: this script looks for a cached copy of the concatentation of the
#     pages.  The cached copy is called .pages.html and is expected in
#     the directory where the script is directed.  It might be good for
#     the script to check if any of the supplied documents are newer
#     than the cached copy and, if so, not return it.
#

PATH=/bin:/usr/bin
test -d /usr/sbin && PATH=$PATH:/usr/sbin		# SGI and others
test -d /usr/5bin && PATH=/usr/5bin:$PATH		# Sun and others

ECHO=@ECHO@
SED=@SED@
CAT=@CAT@
UNQUOTE=@CGIDIR@/unquote

$ECHO 'Content-type: text/html'
$ECHO ''

cd $PATH_TRANSLATED || {
     $CAT<<EOF
<PRE>
Fatal Error: Unable to chdir to directory $PATH_TRANSLATED

This script encountered a problem change to the specified directory.
There is a probably a problem in the URL used to invoke this script.
</PRE>
EOF
     exit 1
}

if [ -f .pages.html ]; then
    $CAT .pages.html
else
    eval `$ECHO "$QUERY_STRING" | $UNQUOTE -qn | $SED 's/PATH=[^;]*;//g'`

    filter()
    {
	$SED -e '/<HEAD>/,/<\/HEAD>/d'\
	    -e '/<[\/]*BODY>/d'\
	    -e '/<ADDRESS>/,/<\/ADDRESS>/d'\
	    -e "s;HREF=\"\([^/#][-a-zA-Z0-9_/.]*\)\";HREF=\"$PATH_INFO/\1\";g"\
	    -e "s;SRC=\"\([^/#][-a-zA-Z0-9_/.]*\)\";SRC=\"$PATH_INFO/\1\";g"\
	    -e '/<[\/]*HTML/d' $*
    }

    test -f "$IF" && $SED \
	-e '/<\/HTML>/d' \
	-e '/<ADDRESS>/,/<\/ADDRESS>/d'\
	-e "s;HREF=\"\([^/#][-a-zA-Z0-9_/.]*\)\";HREF=\"$PATH_INFO/\1\";g"\
	-e "s;SRC=\"\([^/#][-a-zA-Z0-9_/.]*\)\";SRC=\"$PATH_INFO/\1\";g"\
	-e '/<\/BODY>/d' $IF

    i=1
    eval f=\"\$OF${i}\"
    while [ "$f"  ];
    do
	filter $f
	i=`expr $i + 1`
	eval f=\"\$OF${i}\"
    done
fi
exit 0
