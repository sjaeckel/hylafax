.\"	$Header: /usr/people/sam/fax/./man/RCS/hylafax.4f,v 1.30 1995/04/08 21:35:55 sam Rel $
.\"
.\" HylaFAX Facsimile Software
.\"
.\" Copyright (c) 1990-1995 Sam Leffler
.\" Copyright (c) 1991-1995 Silicon Graphics, Inc.
.\" HylaFAX is a trademark of Silicon Graphics
.\" 
.\" Permission to use, copy, modify, distribute, and sell this software and 
.\" its documentation for any purpose is hereby granted without fee, provided
.\" that (i) the above copyright notices and this permission notice appear in
.\" all copies of the software and related documentation, and (ii) the names of
.\" Sam Leffler and Silicon Graphics may not be used in any advertising or
.\" publicity relating to the software without the specific, prior written
.\" permission of Sam Leffler and Silicon Graphics.
.\" 
.\" THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
.\" EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
.\" WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
.\" 
.\" IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
.\" ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
.\" OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
.\" WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
.\" LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
.\" OF THIS SOFTWARE.
.\"
.if n .po 0
.ds Fx \fIHyla\s-1FAX\s+1\fP
.ds Ps P\s-2OST\s+2S\s-2CRIPT\s+2
.TH HYLAFAX 4F "March 3, 1995"
.SH NAME
HylaFAX \- introduction to \*(Fx server operation and file formats
.SH DESCRIPTION
\*(Fx is a system for sending and receiving facsimile.
It supports queued transmission and asynchronous 
reception of facsimile.
Ancillary programs are invoked by
the system for flexibility
and configurability.
\*(Fx includes client and server programs to
support remote submission of jobs for transmission,
remote removal of queued jobs, and to remotely
query the status of jobs queued for transmission.
This document describes the organization of the 
filesystem spooling area in which \*(Fx
server and server-related processes operate, and
introduces the various files that reside in the spooling area.
.SH OVERVIEW
The spooling area is typically located under the
directory
.IR ${SPOOL} .
Ancillary commands used by the servers
.IR faxq (1M),
.IR faxgetty (1M),
and
.IR faxd.recv (1M),
and by administration tools are located in the 
.B bin
subdirectory.
Configuration, access control, and accounting
information are maintained in the
.B etc
and
.B config
subdirectories.
Outgoing jobs are described by files
in the
.B sendq
subdirectory, while received facsimile are deposited in the
.B recvq
subdirectory.
The
.B docq
and
.B temp
subdirectories are also used in the preparation of outbound jobs.
The
.B info
subdirectory contains files that describe the capabilities
of facsimile machines that \*(Fx has called\-\c
this information is used in preparing documents for transmission.
The
.B status
subdirectory contains files that server processes write their
current status to.
The
.B log
subdirectory contains logging information about send and
receive sessions.
.PP
\*(Fx supports multiple modems on a host.
A single process acts as central queueing agent for all outbound jobs.
Typically each modem also has a server process
that monitors the modem status and handles inbound phone calls.
Per-modem server processes communicate with the central queueing
agent using 
.SM FIFO
special files; see
.IR mknod (2)
or
.IR mkfifo (2).
Any other synchronization between server processes
is done using file-level locking.
The
.I faxq
process listens for commands written to the file named
.BR FIFO ,
while each
.I faxgetty
process listens for commands written to a per-device file named
.BI FIFO .devid
(where
.I devid
is an identifier derived from the name of the device
special file to which the modem is connected; e.g.
.I ttym2
for
.IR /dev/ttym2 ,
.I term_10
for
.IR /dev/term/10 .)
To send a command to the queueing agent, one writes to
.BR FIFO .
This is useful, for example, for submitting a job for
transmission.
To send a command to a specific 
.I faxgetty
process, the
.BI FIFO .devid
file is used.
.SH SENDING
Each outgoing facsimile job has a job description file
that is located in the
.B sendq
subdirectory.
This file contains all the information necessary to
manage the transmission; c.f.
.IR sendq (4F).
The actual documents that are to be sent are located
in the
.B docq
subdirectory.
\*(Fx accepts \*(Ps and 
.SM TIFF
Class F documents for transmission.
\*(Ps documents are automatically converted to 
.SM TIFF
documents prior to transmission according to the capabilities
of the remote facsimile machine: maximum page width
and length, ability to handle 2D-encoded data, and ability
to handle high resolution (7 line/mm) data.
This remote machine capability information is stored
in files in the
.B info
subdirectory.
If a machine has not been called before,
\*(Fx assumes the remote machine has the requested capabilities.
If a capabilities mismatch is detected while sending a facsimile
\*(Fx will disconnect and reconvert the submitted documents according
to the newly discovered capabilities.
.PP
The actual transmission is handled by a
.IR faxsend (1M)
process that is initiated by the scheduler.
This program may be substituted for by specifying the
.B FaxSendCmd
configuration parameter in the
.I faxq
configuration file.
.PP
While a job is being processed by a server process,
its job description file is locked for exclusive
use with
.IR flock (2).
The
.IR faxd.recv (1M)
program uses this information to tell if a job is being processed.
.PP
If the
.B SessionTracing
parameter in a server's configuration file is non-zero,
then tracing information for an outgoing job will be logged
in a file in the
.B log
subdirectory.
Each destination machine has a separate log file named
by its canonical phone number.
.PP
The remote job submission facility includes host and user
access control.
The file
.B etc/hosts
must be present and list those hosts and users that are
permitted to queue jobs for transmission or do other operations
that alter the status of a job.
Note that it is necessary to include the ``local host''
definition (usually 127.0.0.1) if local submission
is to be permitted.
For more information consult
.IR hosts (4F).
.PP
There are a number of controls on outbound calls that can be
specified using the
.B etc/destcontrols
file (or whatever file is specified in a
.B DestControls
configuration parameter in the
.I faxq
configuration file).
This file, described in
.IR destctrls (4F),
allows an administrator to restrict calls by phone number
and to control the time of day that calls may be placed.
In addition, operational parameters such as the maximum number
of pages in a facsimile transmission can be constrained
on a per-destination basis.
.PP
If an error is encountered during transmission and a subsequent
retransmission would not include the original cover page, then
\*(Fx can be configured to generate a
.I "continuation cover page"
that is prepended to the retransmitted pages.
Such cover pages are usually generated by the
.B bin/mkcover
command; though the exact command to use can be specified in the 
configuration file read by
.IR faxq .
.SH RECEIVING
.I faxgetty
server processes can be configured to answer incoming
phone calls and automatically receive facsimile.
Received documents are placed in the
.B recvq
subdirectory as
.SM TIFF
Class F files.
The 
.I faxgetty
processes can be configured to make these files publicly
accessible, or they can be made private in which case
an administrator must manage their delivery.
When a facsimile is received, the 
.I faxgetty
process usually invokes the
.B bin/faxrcvd
command; though the exact command to invoke can be specified
in the per-modem configuration file.
The default
.I notify
command is a shell script that sends a mail
message to a well known user, the
.IR FaxMaster ,
but one might also, for example, automatically spool the
document for printing.
.PP
\*(Fx supports a simple form of access control for receiving facsimile.
Each
.I faxgetty
process may be configured to check the
Transmission Subscriber Identifiers (\s-1TSI\s+1)
of the remote fax machine against an access control list, typically
.BR etc/tsi .
Only if the 
.SM TSI
is matched by a regular expression pattern in the file,
is the remote machine permitted to transmit a document.
This mechanism can be used, for example, to guard against
.IR "junk fax" .
.SH POLLING
\*(Fx supports the polled retrieval of facsimile documents.
Documents that are received because of a poll request are
stored in the
.B recvq
subdirectory and also delivered directly to the requester using the
.B bin/pollrcvd
command; though the exact command to invoke can be specified
with the
.B PollRcvdCmd
configuration parameter.
The
.B pollrcvd
script typically encodes the binary facsimile data and
returns it to the user via electronic mail.
.SH "INBOUND CALL HANDLING"
In environments where Caller-ID information is available,
\*(Fx also supports a call screening facility similar to the
.SM TSI
access control facility.
.I faxgetty
can be configured to check the phone number of each caller
against an access control list, typically
.BR etc/cid .
Only if the number is matched by a regular expression pattern
in the file is the call answered.
All Caller ID information is logged, irregardless of whether
or not it is used to screen incoming calls.
.PP
.I faxgetty
is also capable of using \fIdistinctive ring\fP information
to identify whether an inbound call is voice, data, or fax.
Consult the 
.BR RingData ,
.BR RingFax ,
and
.B RingVoice
parameters in
.IR config (4F)
for a description of this facility.
.SH "DATA CALLS"
Most fax modems also support non-facsimile communication.
\*(Fx uses the locking mechanism employed by
.IR uucp (1C),
.IR cu (1C),
.IR slip (1M),
and
.IR ppp (1M).
Any
.I faxgetty
processes will transparently ``get out of the way''
when an application wants to use a modem for an outgoing call.
In addition, \*(Fx can be configured to deduce whether an incoming
call is for facsimile or data use.
If a call from a data modem is recognized and the
.B GettyArgs
parameter is specified in the configuration file,
.I faxgetty
will invoke the
.IR getty (1M)
program so that caller may login to the system.
Similar functionality is also available for invoking
a ``voice getty'' process, though auto-detection of inbound
voice calls is less extensive.
.SH STATUS
\*(Fx maintains status information in several forms.
General status information for each server process is maintained
in the
.B status
subdirectory and returned to users by the
.IR faxstat (1)
program.
The
.IR syslog (3)
facility is used by all server processed
for logging status and error diagnostics.
The server processes may also be configured to log various
kinds of debugging and tracing information; c.f.
the
.B ServerTracing
parameter description in
.IR config (4F).
.PP
Any problems encountered when transmitting a facsimile
are described in messages returned to the user by electronic mail.
A user may also request notification by mail when a
job is requeued; for example, because a call failed.
Notification by electronic mail is implemented by the
.B bin/notify
command script; though the name of the script may be overridden
with the
.B NotifyCmd
configuration parameter.
.PP
The
.IR faxstat
utility provides (remote) status of jobs queued
for transmission, jobs received, and the general
status of server processes.
.PP
The file
.B etc/xferlog
contains status information about all facsimile sent and
received on a machine.
This file is in a simple
.SM ASCII
format that is easy to manipulate with programs such as
.IR awk (1),
to generate accounting information.
See
.IR xferlog (4F)
for information about the format.
See
.IR xferstats (1M)
and
.IR recvstats (1M)
for example scripts that print summarized accounting information.
.SH NOTES
Automatic routing of incoming facsimile is desirable.
.SH FILES
.nf
.ta \w'etc/config.<devid>    'u
FIFO	fifo for job submission
FIFO.<devid>	fifo for communicating with a faxgetty process
${SBIN}/faxinfo	command that prints information about received facsimile
${SBIN}/faxquit	command to force server to quit
bin/faxrcvd	faxd command for handling newly received facsimile
bin/mkcover	faxd command for generating continuation cover pages
bin/notify	faxd command for doing user notification
bin/pollrcvd	faxd command for delivering facsimile received by poll
bin/ps2fax	faxd command for converting \*(Ps to TIFF
docq/doc*	documents queued for transmission
etc/cid	caller id access control list
etc/config.<devid>	configuration data for <devid>
etc/hosts	hosts that may submit jobs for transmission
etc/tsi	fax machine receive access control list
etc/xferlog	log of facsimile sent and received
info/*	data base of remote fax machine capabilities
config/*	prototype configuration files used by \fIfaxaddmodem\fP
log/*	session logging records
recvq/fax*	received facsimile
sendq/q*	descriptions of jobs queued for transmission
status/*	server status information
tmp/*	temporary files created when submitting a job
.fi
.SH "SEE ALSO"
.IR faxq (1M),
.IR faxgetty (1M),
.IR faxd.recv (1M),
.IR faxsend (1M),
.IR faxrcvd (1M),
.IR notify (1M),
.IR pollrcvd (1M),
.IR recvstats (1M),
.IR xferstats (1M),
.IR config (4F),
.IR dialrules (4F),
.IR hosts (4F),
.IR info (4F),
.IR log (4F),
.IR tsi (4F),
.IR recvq (4F),
.IR sendq (4F),
.IR status (4F),
.IR xferlog (4F),
